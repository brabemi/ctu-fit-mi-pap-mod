\documentclass[12pt]{article}
\usepackage[utf8]{inputenc}
\usepackage[czech]{babel}
\usepackage{enumitem}
\usepackage{caption}
\usepackage{url}
\usepackage{graphicx}
\usepackage{footnote}
\makesavenoteenv{tabular}

\usepackage{float}

\begin{document}

\begin{center}
\bf Semestrální projekt MI-PAP 2015/2016:\\[5mm]
    Modelování částic\\[5mm]
       Miroslav Brabenec\\
       Jan Nováček\\[2mm]
magisterské studium, FIT ČVUT, Thákurova 9, 160 00 Praha 6\\[2mm]
\today
\end{center}
%
%
%
% Co má být ve zprávě: https://edux.fit.cvut.cz/courses/MI-PAP/labs/technicka_zprava
%
%
\section{Definice problému, popis sekvenčního algoritmu a jeho implementace}

\subsection{Definice problému}
Implementujte tento algoritmus (viz \url{http://www.browndeertechnology.com/docs/BDT_OpenCL_Tutorial_NBody-rev3.html#algorithm}) a upravte ho takto:

\begin{enumerate}
\item	částice při nárazu provedou pružný odraz a
\item	každá částice má svůj náboj
\end{enumerate}

Úkol: doplňte o možnost vizualizace (alespoň exportem dat v daných časových okamžicích ve formátu vhodném pro vizualizaci v nástroji třetích stran např. ) 

\subsection{Popis sekvenčního algoritmu}
Simulátor načte nastavení simulace ze vstupního souboru, z toho nainicializuje hodnoty a spustí simulaci.

V každém kroku simulace se vypočítává nová pozice každé částice, nová pozice záleží na vlastnostech dané částice a také na vlivu ostatních částic na tuto částici.

Simulace končí po provedení zadaného počtu kroků.

Vizualizovat simulaci lze dvěma způsoby.
První umožňuje sledovat průběh simulace jako animaci přímo za běhu, k tomu byla využita knihovna CImg.
Druhý způsob využívá moožností programu gnuplot,
simulátor vytvoří zdrojový soubor pro vizualizaci v gnuplotu a zároveň vytvoří soubor se zdrojovými daty, která se mají vykreslit.

\subsection{Sekvenční implementace}

Bylo implementováno několik sekvenčních variant, lišících se v míře ruční vektorizace struktur použitých v algoritmu.

První varianta (V1) používá pouze automatickou optimalizaci, nepoužívá žádné SSE instrukce ani ručně vytvořené vektory.

V druhé variantě (V2) je automatická optimalizace a vektorizace. % a SSE instrukce pro výpočet ${\frac{1}{\sqrt{x}}}$.

Ve třetí variantě (V3) je automatická optimalizace a vektorizace, SSE datové typy~\_\_m128 a SSE in\-struk\-ce pro výpočet ${\frac{1}{\sqrt{x}}}$.

Porovnání rychlostí jednotlivých sekvenčních implementací je v tabulce níže.

\begin{center}
\begin{tabular}{c | c | c | c | c}
\textbf{Počet částic} & \textbf{Počet kroků sim.}  & \textbf{V1} & \textbf{V2} & \textbf{V3} \\ \hline \hline
1024 & 50 000 & 760.19s & 149.38s & 97.98s \\ \hline
512 & 400 000 & 1526.06s & 357.50s & 202.17s \\ \hline
4096 & 5 000 & 1215.77s & 207.57s & 153.81s \\ \hline
8192 & 1 500 & 1459.20s & 242.25s & 184.60s \\ \hline
\end{tabular}
\captionof{table}{Časy sekvenčních implementací}
\end{center}

\section{Popis paralelního algoritmu a jeho implementace v OpenMP}
%Popis případných úprav algoritmu a jeho implementace, včetně volby datových struktur
Paralelizace algoritmu proběhla tak, že se v každém kroku simulace rozdělí částice mezi zadaný počet vláken, paralelně se tedy počítají nové pozice částic.
Rozdělení částic mezi vlákna bylo ponecháno na OpenMP.

% Zda byla využita vektorizace (popř. proč jí nemožno využít)
\subsection{Vektorizace}

V prog\-ramu byla nej\-prve pou\-žita au\-toma\-tická vekto\-ri\-za\-ce (-O3).
Její výsledek měl na rychlost výpočtu minimální vliv. Za nejkritičtější část kódu byla vyhodnocena část, kde se počítá ${\frac{1}{\sqrt{x}}}$.
Pro tento úsek kódu lze využít speciální vektorové instrukce. Použitím této instrukce došlo ke znatelnému zrychlení výpočtu.
V další fázi byl kód upraven, tak aby bylo možné využít vektorové instrukce které dokáží počítat paralelně několik hodnot ${\frac{1}{\sqrt{x}}}$.
Zde byly částice rozděleny do chunků po 4 a v každém kroku se počítá ovlivnění částice chunkem částic.
Díky tomu je možné počítat 4 inverzní odmocniny naráz a dochází k rapidnímu zrychlení. 

% Popis optimalizací pro dosažení lineárního zrychlení
\subsection{Optimalizace}
Pro vektorizaci byly využity technologie obsažené v SSE2. Dalšího zrychlení by bylo možno dosáhnout při použití novějších vektorových instrukcí.
Ty by měly umožňovat tvorbu chunků o velikosti 8, případně 16.
Dále by také bylo možno upravit kód, tak aby docházelo k počítání vzdálenosti mezi částicemi pouze jednou.
Momentálně se počítá vzdálenost mezi částicemi A a B dvakrát, jednou z pohledu částice A a jednou z pohledu částice B.

\subsection{Vstupní data}
Pro měření jsme vytvořili 4 vzorky dat. Vzorky dat se lišily v počtu částic a počtu kroků simulace.
Všechny vzorky byly srovnatelné co se týče výpočetní náročnosti. Výpočetní náročnost lze spočítat jako ${N = P^2 \times S}$, kde P = počet částic a S = počet kroků.
Efektivita paralelního výpočtu se zlepšuje s rostoucím počtem částic.

\begin{center}
\begin{tabular}{c | c | c }
\textbf{Počet částic} & \textbf{Počet kroků sim.}  & \textbf{Výpočetní náročnost}\footnote{Spočítáno podle vzorce ${\frac{P^2 \times S}{10^9}}$, kde P = počet částic a S = počet kroků} \\ \hline \hline
1024 & 50 000 & 52,428 \\ \hline
512 & 400 000 & 104,857 \\ \hline
4096 & 5 000 & 83,804 \\ \hline
8192 & 1 500 & 100,663 \\ \hline
\end{tabular}
\captionof{table}{Vzorky použité pro srovnání sekvenčních implementací}
\end{center}

Po naměření časů sekvenčních implementací bez vektorizace a s vektorizací jsme usoudili, že pro měření paralelních implementací zvýšíme výpočetní náročnost úloh.
Samotná vektorizace zrychlila sekvenční část mnohonásobně - simulace běžící sekvenčně bez vektorizace téměř 25 minut trvala s vektorizací 3-4 minuty.

\begin{center}
\begin{tabular}{c | c | c | c}
\textbf{Měření} & \textbf{Počet částic} & \textbf{Počet kroků sim.} & \textbf{Výpočetní náročnost} \\ \hline \hline
1 & 1024 & 150 000 & 157,284 \\ \hline
2 & 512 & 1 200 000 & 314,571 \\ \hline
3 & 4096 & 15 000 & 251,412 \\ \hline
4 & 8192 & 4 500 & 301.989 \\ \hline
\end{tabular}
\captionof{table}{Nové zadání pro měření paralelního zrychlení}
\end{center}

% Tabulkově a případně graficky zpracované naměřené hodnoty časové složitosti měřených instancí běhu (optimalizované implementace) programu s popisem instancí dat
\section{Naměřené výsledky a vyhod\-noce\-ní pro O\-pen\-MP}
K měření výkonu paralelní implementace bylo původní zadání pozměněno tak, aby bylo výpočetně náročnější, viz předchozí tabulka.
U každého měření je uvedena tabulka s počtem vláken a časem výpočtu ve vteřinách, informace z tabulky jsou dále vyneseny do grafu.
Na konci měření k jednotlivým variantám jsou grafy s paralelním zrychlením.
Na konci sekce je porovnání a vyhodnocení měření.

\subsection{Měření pro variantu 2}
Varianta 2 využívá automatické vektorizace. % (-O3) a SSE instrukce pro výpočet ${\frac{1}{\sqrt{x}}}$.
%
% 1. měření
%
\begin{center}
\begin{tabular}{ c | c }
\textbf{Počet vláken} & \textbf{Naměřený čas} \\ \hline \hline 
1 & 448.140625s \\ \hline
2 & 422.681641s \\ \hline
4 & 269.634277s \\ \hline
8 & 253.593750s \\ \hline
12 & 220.276367s \\ \hline
16 & 188.523438s \\ \hline
24 & 188.625000s \\ \hline
\end{tabular}
\captionof{table}{Časy 1. měření}
\end{center}

\begin{figure}[H]
  \begin{center}
     \includegraphics[width=12cm]{images/auto1.png}
    \caption{Měření 1. instance} 
  \end{center}
\end{figure}
%
% 2. měření
%
\begin{center}
\begin{tabular}{ c | c }
\textbf{Počet vláken} & \textbf{Naměřený čas} \\ \hline \hline 
1 & 1066.172363s \\ \hline
2 & 1004.078125s \\ \hline
4 & 773.147461s \\ \hline
8 & 765.203125s \\ \hline
12 & 807.484375s \\ \hline
16 & 782.453125s \\ \hline
24 & 640.501953s \\ \hline
\end{tabular}
\captionof{table}{Časy 2. měření}
\end{center}

\begin{figure}
  \begin{center}
    \includegraphics[width=12cm]{images/auto2.png}
    \caption{Měření 2. instance} 
  \end{center}
\end{figure}
%
% 3. měření
%
\begin{center}
\begin{tabular}{ c | c }
\textbf{Počet vláken} & \textbf{Naměřený čas} \\ \hline \hline 
1 & 621.765625s \\ \hline
2 & 364.220703s \\ \hline
4 & 185.841797s \\ \hline
8 & 109.250000s \\ \hline
12 & 101.171875s \\ \hline
16 & 84.234375s \\ \hline
24 & 74.109375s \\ \hline
\end{tabular}
\captionof{table}{Časy 3. měření}
\end{center}

\begin{figure}[H]
  \begin{center}
     \includegraphics[width=12cm]{images/auto3.png}
    \caption{Měření 3. instance} 
  \end{center}
\end{figure}
%
% 4. měření
%
\begin{center}
\begin{tabular}{ c | c }
\textbf{Počet vláken} & \textbf{Naměřený čas} \\ \hline \hline 
1 & 720.630859s \\ \hline
2 & 372.531250s \\ \hline
4 & 190.187500s \\ \hline
8 & 92.015625s \\ \hline
12 & 84.015625s \\ \hline
16 & 76.273438s \\ \hline
24 & 51.625000s \\ \hline
\end{tabular}
\captionof{table}{Časy 4. měření}
\end{center}

\begin{figure}[H]
  \begin{center}
     \includegraphics[width=12cm]{images/auto4.png}
    \caption{Měření 4. instance} 
  \end{center}
\end{figure}

Z naměřených výsledků lze usoudit, že paralelizace algoritmu zredukuje výpočetní čas znatelně, až 14*.
Z měření je vidět, že čím více částic bylo v simulaci, tím vyššího zrychlení bylo dosaženo.
Vyšší počet kroků simulace naopak zrychlení spíš srážel, někdy dokonce zpomaloval.
Lineárního zrychlení dosaženo nebylo, jak je vidět z následujících grafů.

\begin{figure}[H]
  \begin{center}
     \includegraphics[width=12cm]{images/auto1acc.png}
    \caption{Paralelní zrychlení v 1. měření} 
  \end{center}
\end{figure}

\begin{figure}[H]
  \begin{center}
     \includegraphics[width=12cm]{images/auto2acc.png}
    \caption{Paralelní zrychlení v 2. měření} 
  \end{center}
\end{figure}

\begin{figure}
  \begin{center}
     \includegraphics[width=12cm]{images/auto3acc.png}
    \caption{Paralelní zrychlení v 3. měření} 
  \end{center}
\end{figure}

\begin{figure}[H]
  \begin{center}
     \includegraphics[width=12cm]{images/auto4acc.png}
    \caption{Paralelní zrychlení v 4. měření} 
  \end{center}
\end{figure}

\subsection{Měření pro variantu 3}
Ve třetí variantě (V3) je automatická optimalizace, automatická a ruční vektorizace, mj. SSE datové typy~\_\_m128 a SSE in\-struk\-ce pro výpočet ${\frac{1}{\sqrt{x}}}$.
%
% 1. měření
%
\begin{center}
\begin{tabular}{ c | c }
\textbf{Počet vláken} & \textbf{Naměřený čas} \\ \hline \hline 
1 & 292.988647s \\ \hline
2 & 321.015625s \\ \hline
4 & 206.636963s \\ \hline
8 & 191.578125s \\ \hline
12 & 189.591797s \\ \hline
16 & 159.812500s \\ \hline
24 & 144.281250s \\ \hline
\end{tabular}
\captionof{table}{Časy 1. měření}
\end{center}

\begin{figure}[H]
  \begin{center}
     \includegraphics[width=12cm]{images/ssef1.png}
    \caption{Měření 1. instance} 
  \end{center}
\end{figure}
%
% 2. měření
%
\begin{center}
\begin{tabular}{ c | c }
\textbf{Počet vláken} & \textbf{Naměřený čas} \\ \hline \hline 
1 & 607.515625s \\ \hline
2 & 675.796875s \\ \hline
4 & 592.843750s \\ \hline
8 & 683.521484s \\ \hline
12 & 845.265625s \\ \hline
16 & 696.267578s \\ \hline
24 & 587.625000s \\ \hline
\end{tabular}
\captionof{table}{Časy 2. měření}
\end{center}

\begin{figure}[H]
  \begin{center}
      \includegraphics[width=12cm]{images/ssef2.png}
    \caption{Měření 2. instance} 
  \end{center}
\end{figure}
%
% 3. měření
%
\begin{center}
\begin{tabular}{ c | c }
\textbf{Počet vláken} & \textbf{Naměřený čas} \\ \hline \hline 
1 & 398.190857s \\ \hline
2 & 284.056641s \\ \hline
4 & 152.609375s \\ \hline
8 & 123.656250s \\ \hline
12 & 105.606934s \\ \hline
16 & 78.484375s \\ \hline
24 & 67.243164s \\ \hline
\end{tabular}
\captionof{table}{Časy 3. měření}
\end{center}

\begin{figure}[H]
  \begin{center}
      \includegraphics[width=12cm]{images/ssef3.png}	
    \caption{Měření 3. instance} 
  \end{center}
\end{figure}
%
% 4. měření
%
\begin{center}
\begin{tabular}{ c | c }
\textbf{Počet vláken} & \textbf{Naměřený čas} \\ \hline \hline 
1 & 553.531250s \\ \hline
2 & 277.496094s \\ \hline
4 & 139.218750s \\ \hline
8 & 72.937500s \\ \hline
12 & 48.828125s \\ \hline
16 & 62.685547s \\ \hline
24 & 42.093750s \\ \hline
\end{tabular}
\captionof{table}{Časy 4. měření}
\end{center}

\begin{figure}[H]
  \begin{center}
      \includegraphics[width=12cm]{images/ssef4.png}	
    \caption{Měření 4. instance} 
  \end{center}
\end{figure}

Paralelizace varianty č. 3 zrychlila výpočet až 13*. 
Naměřené výsledky ukazují, že efektivnější využití více vláken ve variantě č. 3 se projeví zejména při vyšším počtu částic.
Následují grafy paralelního zrychlení.

\begin{figure}[H]
  \begin{center}
     \includegraphics[width=12cm]{images/ssef1acc.png}
    \caption{Paralelní zrychlení v 1. měření} 
  \end{center}
\end{figure}

\begin{figure}[H]
  \begin{center}
     \includegraphics[width=12cm]{images/ssef2acc.png}
    \caption{Paralelní zrychlení ve 2. měření} 
  \end{center}
\end{figure}

\begin{figure}[H]
  \begin{center}
     \includegraphics[width=12cm]{images/ssef3acc.png}
    \caption{Paralelní zrychlení ve 3. měření} 
  \end{center}
\end{figure}

\begin{figure}[H]
  \begin{center}
     \includegraphics[width=12cm]{images/ssef4acc.png}
    \caption{Paralelní zrychlení ve 4. měření} 
  \end{center}
\end{figure}

% Analýza a hodnocení vlastností dané implementace programu.
\subsection{Porovnání jednotlivých implementací}
První varianta algoritmu, tj. sekvenční s pouze automatickou vektorizací, vyšla jako nejpomalejší ze všech variant.

Vektorizace v dalších dvou variantách přinesla obrovské zrychlení, varianta 2 je oproti variantě 1 až 6* rychlejší, varianta 3 oproti variantě 1 přibližně 8*.

Spuštění varianty 2 na více vláknech přineslo zrychlení až 14*. Z jednotlivých měření lze usoudit, že zrychlení se zvyšuje i s větším množstvím částic.
Varianta 2 nikdy výpočet nezpomalila, její sekvenční implementace sice je pomalejší než varianta 3, ale v paralelizaci dosahovala většího zrychlení.

Spuštění varianty 3 na více vláknech zrychlilo výpočet až 13,1*.
Bohužel to v některých případech výpočet i zpomalilo, to přisuzujeme příliš malému množství částic v kombinaci s řežií spojenou s vlákny.
Zrychlení je naopak patrné v měření 3 a 4, kdy se při větším počtu částic výpočet znatelně zrychloval s přibývajícími vlákny.
Varianta 3 také těžila z velmi dobrého sekvenčního času, který předčil i variantu 2 s automatickou opt. a vektorizací.

Dále jsou uvedeny grafy porovnávající variantu 2 a 3, ukazují vliv vektorizace na rychlost výpočtu.

\begin{figure}
  \begin{center}
      \includegraphics[width=12cm]{images/vs1.png}	
    \caption{Porovnání implementací, měření 1} 
  \end{center}
\end{figure}

\begin{figure}
  \begin{center}
      \includegraphics[width=12cm]{images/vs2.png}	
    \caption{Porovnání implementací, měření 2}
  \end{center}
\end{figure}

\begin{figure}
  \begin{center}
      \includegraphics[width=12cm]{images/vs3.png}	
    \caption{Porovnání implementací, měření 3}
  \end{center}
\end{figure}

\begin{figure}
  \begin{center}
      \includegraphics[width=12cm]{images/vs4.png}	
    \caption{Porovnání implementací, měření 4}
  \end{center}
\end{figure}


\end{document}
